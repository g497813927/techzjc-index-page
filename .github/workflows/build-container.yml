name: Docker Build & Push and Deploy to Alibaba Cloud FC

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-amd64:
    name: Build and Push Docker Image (amd64)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ vars.IMAGE }}:temp-amd64-${{ github.sha }}
  build-arm64:
    name: Build and Push Docker Image (arm64)
    runs-on: mac-m4-max
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Use job-local Docker config (no keychain)
        run: |
          echo "DOCKER_CONFIG=$RUNNER_TEMP/docker-config" >> $GITHUB_ENV
          mkdir -p "$RUNNER_TEMP/docker-config"
          echo '{ "credsStore": "" }' > "$RUNNER_TEMP/docker-config/config.json"
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push images
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: |
            ${{ vars.IMAGE }}:temp-arm64-${{ github.sha }}
  build-combined:
    name: Build and Push Multi-Arch Docker Image
    needs:
      - build-amd64
      - build-arm64
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ vars.IMAGE }}:${{ github.sha }}
            ${{ vars.IMAGE }}:${{ github.ref_name}}
            ${{ vars.IMAGE }}:latest
      - name: Remove temporary images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ github.event.repository.name }}
          TAG1: temp-amd64-${{ github.sha }}
          TAG2: temp-arm64-${{ github.sha }}
        run: |
          set -euo pipefail
          base=""
          if gh api -H "Accept: application/vnd.github+json" \
            "/orgs/${OWNER}/packages/container/${PACKAGE}/versions?per_page=100" >/dev/null 2>&1; then
            base="/orgs/${OWNER}/packages/container/${PACKAGE}"
          else
            base="/users/${OWNER}/packages/container/${PACKAGE}"
          fi

          echo "Using API base: $base"

          delete_tag () {
            local tag="$1"
            echo "Looking for package versions with tag: $tag"

            # Get all version ids that have this tag
            ids=$(gh api -H "Accept: application/vnd.github+json" \
              "${base}/versions?per_page=100" \
              --paginate \
              | jq -r --arg TAG "$tag" '
                  .[] | select(any(.metadata.container.tags[]?; . == $TAG)) | .id
                ')

            if [ -z "${ids}" ]; then
              echo "No versions found for tag: $tag (already deleted?)"
              return 0
            fi

            for id in $ids; do
              echo "Deleting version id: $id (tag: $tag)"
              gh api -X DELETE -H "Accept: application/vnd.github+json" \
                "${base}/versions/${id}"
            done
          }

          delete_tag "$TAG1"
          delete_tag "$TAG2"
  deploy:
    needs: build-combined
    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Serverless Devs
        run: npm install -g @serverless-devs/s

      - name: Deploy to Alibaba Cloud FC
        env:
          REGION: ${{ vars.REGION }}
          FC_NAME: ${{ vars.FC_NAME }}
          IMAGE_FULL: "${{ vars.IMAGE }}:${{ github.sha }}"
          default_serverless_devs_key: "{\"AccountID\":\"${{ secrets.ALIYUN_ACCOUNT_ID }}\",\"AccessKeyID\":\"${{ secrets.ALIYUN_ACCESS_KEY_ID }}\",\"AccessKeySecret\":\"${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}\"}"
        run: |
          s deploy -t s.yaml --use-local -y
